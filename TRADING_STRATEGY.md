업비트 자동매매 프로그램 - SMC 기반 매매 전략 프롬프트

🔑 핵심 철학

스마트 머니(기관/세력)의 흔적을 따라간다. 이기려 하지 말고, 그들이 남긴 빵조각을 먹는다.
단일 근거가 아니라 복수 근거가 겹치는 구간에서만 매매한다.
자리가 안 오면 매매하지 않는다(FOMO 금지).


📊 사용 타임프레임 설정
매매 스타일분석 타임프레임진입 타임프레임단타1시간, 15분5분단기 스윙4시간, 1시간15분중기 스윙일봉, 4시간1시간
원칙: 상위 타임프레임에서 방향성과 구조물을 확인하고, 하위 타임프레임에서 정밀 진입 타이밍을 잡는다.

1. 오더블럭(Order Block) 감지 로직
1-1. 상승 오더블럭 (Bullish OB) — 매수 신호
정의: 가격이 하락하다가 급반등하기 직전, 마지막 음봉(또는 음봉→양봉 패턴)의 몸통 구간
감지 조건:
패턴 A (2캔들): [음봉] → [양봉(장대)]
패턴 B (3캔들): [양봉] → [음봉] → [양봉(장대)]

필수 조건:
1. 마지막 양봉의 종가 > 음봉의 시가 (방향 전환 확인)
2. 마지막 양봉의 몸통 크기 ≥ 음봉 몸통의 2배 이상 (갭 조건)
3. 첫 번째 캔들이 도지캔들(몸통이 기형적으로 작은 경우)이면 제외
4. 오더블럭 범위 = 음봉의 시가(Open) ~ 음봉의 종가(Close) (몸통 기준)
1-2. 하락 오더블럭 (Bearish OB) — 매도 신호
정의: 가격이 상승하다가 급락하기 직전, 마지막 양봉(또는 양봉→음봉 패턴)의 몸통 구간
감지 조건:
패턴 A (2캔들): [양봉] → [음봉(장대)]
패턴 B (3캔들): [음봉] → [양봉] → [음봉(장대)]

필수 조건:
1. 마지막 음봉의 종가 < 양봉의 시가 (방향 전환 확인)
2. 마지막 음봉의 몸통 크기 ≥ 양봉 몸통의 2배 이상
3. 오더블럭 범위 = 양봉의 시가(Open) ~ 양봉의 종가(Close) (몸통 기준)
1-3. 오더블럭 신뢰도 점수 시스템
각 오더블럭에 점수를 부여하여 신뢰도를 판단한다. 3점 이상일 때만 유효한 OB로 채택.
조건점수유동성 흡수(Liquidity Sweep) 후 발생 — 직전 스윙 고/저점을 갱신한 뒤 반전+2다른 구조물(FVG, 추세선, 채널) 구간과 겹침+2캔들 몸통 크기 차이 2배 이상 (갭 조건 충족)+1캔들 몸통 크기 차이 3배 이상+1 (추가)상위 타임프레임의 OB/FVG 구간 내에서 발생+2아직 한 번도 터치(Mitigate)되지 않은 신선한 OB+1이미 1회 이상 터치된 OB-1

2. FVG(Fair Value Gap) 감지 로직
2-1. 상승형 FVG (Bullish FVG) — 매수 지지 구간
정의: 3개 연속 캔들에서 가격이 급등하며 남긴 빈 공간. 가격이 되돌아와 지지받을 구간.
감지 조건:
3개 연속 캔들: [캔들1] → [캔들2(장대 양봉)] → [캔들3]

필수 조건:
1. 캔들2의 몸통이 캔들1, 캔들3보다 최소 2~3배 이상 크다
2. 캔들1의 고가(High) < 캔들3의 저가(Low) → 이 사이에 빈 공간이 존재
3. FVG 범위 = 캔들1의 High ~ 캔들3의 Low
4. 빈 공간이 실제로 존재해야 함 (캔들1.High < 캔들3.Low)
2-2. 하락형 FVG (Bearish FVG) — 매도 저항 구간
감지 조건:
3개 연속 캔들: [캔들1] → [캔들2(장대 음봉)] → [캔들3]

필수 조건:
1. 캔들2의 몸통이 캔들1, 캔들3보다 최소 2~3배 이상 크다
2. 캔들1의 저가(Low) > 캔들3의 고가(High) → 빈 공간 존재
3. FVG 범위 = 캔들3의 High ~ 캔들1의 Low
2-3. FVG 신뢰도 점수 시스템
3점 이상일 때만 유효한 FVG로 채택.
조건점수유동성 흡수(Liquidity Sweep) 직후 발생+2오더블럭과 겹치거나 인접+2캔들2의 몸통이 캔들1,3 대비 3배 이상+1상위 타임프레임 구조물 내에서 발생+2아직 채워지지 않은(Unfilled) 신선한 FVG+1이미 50% 이상 채워진 FVG-1

3. 추세 판단 로직
3-1. 추세선 기반 판단
상승 추세: 의미있는 저점(Swing Low)들을 연결 → 저점이 점점 높아짐
하락 추세: 의미있는 고점(Swing High)들을 연결 → 고점이 점점 낮아짐

추세 확인 조건:
- 최소 2개 이상의 스윙 포인트가 추세선에 닿아야 유효
- 3개 이상 닿으면 신뢰도 상승
3-2. 구조물 돌파(BOS) 기반 판단
상승 BOS: 직전 스윙 고점을 종가 기준으로 돌파 → 상승 추세 지속 확인
하락 BOS: 직전 스윙 저점을 종가 기준으로 돌파 → 하락 추세 지속 확인

추세 전환 신호:
- 상승 추세 중 직전 스윙 저점이 종가 기준으로 이탈 → 하락 전환 경고
- 하락 추세 중 직전 스윙 고점이 종가 기준으로 돌파 → 상승 전환 경고

4. Fake Out / Trap 감지 로직
4-1. Fake Out (거짓 돌파)
감지 조건:
1. 가격이 주요 구조물(지지선/저항선/채널 경계/스윙 고저점)을 돌파
2. 돌파한 캔들이 긴 꼬리(Long Wick)를 만들며 구조물 안으로 복귀
3. 해당 캔들의 몸통 마감(Close)이 구조물 내부

특징: 하나의 고점/저점으로 형성, 급격한 방향 전환
4-2. Trap (함정)
감지 조건:
1. 가격이 주요 구조물을 돌파
2. 돌파 후 1~3개 캔들 동안 바깥에서 머무름 (개인 투자자 유인)
3. 이후 다시 구조물 내부로 급격히 복귀
4. 쌍고점/쌍바닥 형태로 형성

특징: 약간의 텀을 주며 움직임, 쌍고점/쌍바닥 형태
4-3. Fake Out / Trap 이후 매매 전략
확인 매매 (보수적):
- 가격이 구조물 안으로 복귀한 것을 확인
- 복귀 후 해당 구조물을 리테스트(Retest)할 때 진입
- 봉마감으로 복귀를 확인하면 더 안전

예측 분할 매매 (공격적):
- Fake out/Trap이 발생 중인 것으로 판단되면 분할 진입
- 반드시 소액으로 운영
- 구조물별로 분할 진입, 분할 손절

5. 통합 매수 시그널 (BUY SIGNAL)
5-1. 매수 조건 체크리스트 (최소 3개 이상 충족 시 매수)
□ 조건1: 상위 타임프레임에서 상승 추세 확인 (저점이 높아지는 구조)
□ 조건2: 상승 오더블럭(Bullish OB) 구간에 가격 도달 (신뢰도 3점 이상)
□ 조건3: 상승 FVG(Bullish FVG) 구간에 가격 도달 (신뢰도 3점 이상)
□ 조건4: OB와 FVG 구간이 겹침 (복수 근거)
□ 조건5: 유동성 흡수(Liquidity Sweep) 발생 후 반전 캔들 출현
□ 조건6: Fake out/Trap 패턴 발생 후 구조물 내부로 복귀 확인
□ 조건7: 하위 타임프레임에서 반전 캔들(양봉 장악형, 망치형 등) 출현
5-2. 매수 진입가 결정
우선순위:
1순위: OB와 FVG가 겹치는 구간의 상단 (가장 확률 높음)
2순위: OB 구간의 상단 (음봉의 시가 부근)
3순위: FVG 구간의 상단 (캔들3의 Low 부근)

분할 매수 전략:
- 1차 매수: OB/FVG 구간 상단 도달 시 → 총 자금의 50%
- 2차 매수: OB/FVG 구간 중단 도달 시 → 총 자금의 30%
- 3차 매수: OB/FVG 구간 하단 도달 시 → 총 자금의 20%
5-3. 손절(Stop Loss) 설정
기준 1 (보수적, 권장):
- 오더블럭: OB를 형성한 모든 캔들의 꼬리 끝(최저점) 바로 아래
- FVG: FVG를 형성한 3개 캔들의 꼬리 끝(최저점) 바로 아래

기준 2 (공격적, 승률↑ 리스크↑):
- 위 기준에서 "봉마감 이탈" 시 손절 (장중 이탈은 허용)

자동매매 권장: 기준 1 사용 (확실한 이탈 = 즉시 손절)
5-4. 익절(Take Profit) 설정
1차 익절 (포지션의 50%):
- OB 기준: OB가 발생하면서 만들어진 파동의 직전 고점(Swing High) 도달 시
- FVG 기준: FVG가 발생한 파동의 끝(High) 돌파 시

1차 익절 후 조치:
- 나머지 50% 포지션의 손절을 진입가(평단)로 이동 → 본전 보장

2차 익절 (나머지 50%):
- 다음 저항 구조물 도달 시 (하락 OB, Bearish FVG, 채널 상단, 추세선 저항 등)
- 반대 오더블럭(Bearish OB) 출현 시
- 반대 구조물 출현 시

전량 익절 조건:
- 상위 타임프레임의 주요 저항 구간 도달
- 하락 추세로의 전환 신호 발생 (직전 스윙 저점 이탈)

6. 통합 매도 시그널 (SELL SIGNAL)
6-1. 매도 조건 체크리스트 (보유 중인 포지션 청산)
즉시 매도 (손절):
□ 가격이 OB/FVG의 손절 기준선을 하방 이탈

부분 매도 (1차 익절):
□ 직전 스윙 고점 도달
□ 파동의 끝(High) 돌파

전량 매도 (2차 익절 또는 추세 전환):
□ 하락 오더블럭(Bearish OB) 출현
□ 하락 FVG(Bearish FVG) 출현
□ 상위 타임프레임에서 추세 전환 신호 (직전 스윙 저점 봉마감 이탈)
□ 채널 상단 도달 후 반전 캔들 출현
□ Fake out/Trap 발생하여 고점 갱신 후 급락

7. 실시간 감시(Monitoring) 로직
7-1. 감시 주기
타임프레임별 캔들 데이터를 주기적으로 수집:
- 5분봉: 매 5분마다 갱신
- 15분봉: 매 15분마다 갱신
- 1시간봉: 매 1시간마다 갱신
- 4시간봉: 매 4시간마다 갱신

실시간 현재가: 1~3초 간격으로 체크 (진입/손절/익절 트리거용)
7-2. 감시 프로세스 (매 캔들 갱신 시 실행)
STEP 1: 추세 판단
  → 상위 타임프레임(4시간/1시간)에서 현재 추세 확인
  → 상승/하락/횡보 중 어느 상태인지 판단
  → BOS(구조물 돌파) 발생 여부 확인

STEP 2: 구조물 스캔
  → 신규 오더블럭 생성 여부 체크 (상승 OB / 하락 OB)
  → 신규 FVG 생성 여부 체크 (상승 FVG / 하락 FVG)
  → 각 구조물에 신뢰도 점수 부여
  → 기존 구조물의 유효성 검증 (이미 터치/채워졌는지)

STEP 3: 유동성 구간 식별
  → 최근 스윙 고점/저점 식별 (유동성이 쌓인 구간)
  → 해당 구간의 돌파 여부 모니터링
  → Liquidity Sweep 발생 시 → Fake out/Trap 가능성 체크

STEP 4: 진입 조건 평가
  → 현재가가 유효한 OB/FVG 구간에 진입했는지 체크
  → 매수 조건 체크리스트 충족 개수 계산
  → 3개 이상 충족 시 매수 시그널 발동

STEP 5: 포지션 관리
  → 보유 중인 포지션의 손절/익절 트리거 체크
  → 1차 익절 조건 도달 시 → 50% 매도 + 나머지 손절선 이동
  → 2차 익절 조건 도달 시 → 잔여 전량 매도
  → 손절 조건 도달 시 → 즉시 전량 매도
7-3. 구조물 관리 (저장/갱신/삭제)
각 구조물은 다음 정보를 저장:
{
  "type": "bullish_ob" | "bearish_ob" | "bullish_fvg" | "bearish_fvg",
  "timeframe": "5m" | "15m" | "1h" | "4h" | "1d",
  "price_top": float,      // 구간 상단 가격
  "price_bottom": float,   // 구간 하단 가격
  "created_at": datetime,  // 생성 시점
  "reliability_score": int, // 신뢰도 점수
  "touch_count": int,      // 터치 횟수
  "is_valid": bool,        // 유효 여부
  "is_mitigated": bool     // 이미 반응이 완료되었는지
}

구조물 무효화 조건:
- OB: 가격이 OB 구간의 꼬리 끝을 봉마감으로 이탈
- FVG: 가격이 FVG를 완전히 채우고 반대편으로 봉마감 이탈
- 3회 이상 터치된 구조물은 신뢰도 대폭 하락 → 무효 처리

8. 리스크 관리
8-1. 포지션 사이징
1회 매매 최대 손실 = 총 자산의 1~2%
손절 폭에 따라 진입 수량을 역산:
  진입 수량 = (총 자산 × 0.02) / (진입가 - 손절가)
8-2. 동시 포지션 제한
- 최대 동시 보유 코인: 3개
- 동일 코인 중복 진입 금지
- 일일 최대 매매 횟수: 10회 (과매매 방지)
8-3. 시장 상태 필터
매매 금지 조건:
- 비트코인(BTC)이 명확한 하락 추세일 때 알트코인 매수 금지
- 극단적 횡보(볼린저 밴드 스퀴즈 등) 시 추세 확인까지 대기
- 주요 매크로 이벤트(FOMC, CPI 등) 발표 전후 30분간 매매 금지
  → 발표 직후 첫 번째 움직임은 대부분 Fake out

9. 업비트 API 연동 시 주의사항
9-1. 주문 방식
매수: 지정가 주문 (OB/FVG 구간 상단에 미리 주문)
매도(손절): 시장가 주문 (손절은 빠르게 체결되어야 함)
매도(익절): 지정가 주문 (목표가에 미리 주문)
9-2. 캔들 데이터 수집
업비트 API: GET /v1/candles/minutes/{unit}
- unit: 1, 3, 5, 10, 15, 30, 60, 240
- 일봉: GET /v1/candles/days
- 필요 데이터: open, high, low, close, volume, timestamp
- 최소 200개 캔들 데이터 유지 (구조물 분석용)
9-3. 데이터 구조
python# 각 캔들 데이터
candle = {
    "open": float,
    "high": float,
    "low": float,
    "close": float,
    "volume": float,
    "timestamp": datetime
}

# 캔들 판별
is_bullish = candle["close"] > candle["open"]  # 양봉
is_bearish = candle["close"] < candle["open"]  # 음봉
body_size = abs(candle["close"] - candle["open"])  # 몸통 크기
upper_wick = candle["high"] - max(candle["open"], candle["close"])  # 윗꼬리
lower_wick = min(candle["open"], candle["close"]) - candle["low"]  # 아랫꼬리

10. 매매 흐름 요약 (순서도)
[시작]
  │
  ▼
[STEP 1] 상위 TF 추세 판단
  │ → 상승 추세 → 매수 기회 탐색
  │ → 하락 추세 → 매매 보류 또는 매도 기회 탐색
  │ → 횡보 → 구조물 이탈 대기
  │
  ▼
[STEP 2] 구조물 스캔 (OB + FVG)
  │ → 유효한 상승 OB/FVG 발견?
  │   → YES → 신뢰도 점수 계산
  │   → NO → 대기
  │
  ▼
[STEP 3] 신뢰도 3점 이상?
  │ → YES → 해당 구간에 지정가 매수 주문
  │ → NO → 대기
  │
  ▼
[STEP 4] 매수 체결
  │ → 손절 주문 설정 (OB/FVG 꼬리 끝 아래)
  │ → 1차 익절 주문 설정 (직전 스윙 고점)
  │
  ▼
[STEP 5] 포지션 관리
  │ → 1차 익절 도달 → 50% 매도, 나머지 손절을 평단으로 이동
  │ → 2차 익절 도달 → 잔여 전량 매도
  │ → 손절 도달 → 전량 매도
  │ → 반대 시그널 출현 → 전량 매도
  │
  ▼
[종료] → STEP 1로 복귀

11. 코드 구현 시 핵심 함수 목록
1. detect_order_block(candles, direction)
   → 캔들 데이터에서 OB 감지, 상승/하락 구분
   → 반환: OB 객체 리스트 (가격 범위, 신뢰도 점수)

2. detect_fvg(candles, direction)
   → 캔들 데이터에서 FVG 감지
   → 반환: FVG 객체 리스트 (가격 범위, 신뢰도 점수)

3. identify_trend(candles)
   → 스윙 고/저점 추출 후 추세 판단
   → 반환: "uptrend" | "downtrend" | "ranging"

4. detect_liquidity_sweep(candles, swing_points)
   → 유동성 흡수 감지 (스윙 포인트 돌파 후 복귀)
   → 반환: sweep 이벤트 리스트

5. detect_fakeout_trap(candles, structures)
   → Fake out/Trap 패턴 감지
   → 반환: 패턴 객체 (유형, 방향, 위치)

6. calculate_reliability_score(structure, context)
   → 구조물의 신뢰도 점수 계산
   → 반환: 정수 점수

7. generate_buy_signal(current_price, structures, trend)
   → 매수 조건 체크리스트 평가
   → 반환: {signal: bool, entry_price, stop_loss, take_profit_1, take_profit_2}

8. manage_position(position, current_price, structures)
   → 보유 포지션의 손절/익절 관리
   → 반환: {action: "hold" | "partial_sell" | "full_sell", reason}

9. calculate_position_size(total_capital, entry_price, stop_loss_price)
   → 리스크 기반 포지션 사이징
   → 반환: 매수 수량

10. scan_market(market_list)
    → 여러 코인을 순회하며 매수 기회 탐색
    → 반환: 시그널 발생 코인 리스트 (우선순위 정렬)